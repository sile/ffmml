<html>
  <head>
    <meta charset="utf-8">
    <title>FFMML Web Player</title>
  </head>
  <body>
    <h1>FFMML Web Player</h1>
    <div>
      <canvas id="canvas" hidden="hidden"></canvas>
      <textarea id="mml" rows="20" cols="80"></textarea>
    </div>
    <br />
    <div>
      <input value="Play Music" type="button" onclick="playAudio()">
      <input value="Update URL" type="button">
    </div>
    <br />
    <div>
      <textarea id="errorMessageArea"
                style="color:red; font-weight:bold; border:none; resize:none"
                readonly rows="6" cols="80">
      </textarea>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pagurus@0.6.0/dist/pagurus.min.js"></script>
    <script>
      var system = undefined;
      var game = undefined;

      function playAudio() {
          const mml = document.getElementById("mml").value;
          const mmlBytes = new TextEncoder().encode(mml);

          const errorMessage = document.getElementById("errorMessageArea");
          errorMessage.value = "";

          try {
              game.command(system, "playAudio", mmlBytes);
          } catch (e) {
              console.warn(e);

              const error = JSON.parse(e.message);
              errorMessage.value = "ERROR: " + error.message;
          }
      }

      Pagurus.Game.load("ffmml.wasm").then(async gameObject => {
          game = gameObject;

          const canvas = document.getElementById("canvas");
          system = await Pagurus.System.create(game.memory, canvas);

          game.initialize(system);
          while (true) {
              const event = await system.nextEvent();
              try {
                  if (!game.handleEvent(system, event)) {
                      break;
                  }
              } catch (e) {
                  console.warn(e);

                  const errorMessage = document.getElementById("errorMessageArea");
                  const error = JSON.parse(e.message);
                  errorMessage.value = "ERROR: " + error.message;
              }
          }
      });
    </script>
  </body>
</html>
